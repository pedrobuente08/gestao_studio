// ============================================================
// INKSTUDIO — Schema do Prisma
// ============================================================
// Convenção: valores monetários salvos em centavos (Int)
// Exemplo: R$ 1.500,00 = 150000
// ============================================================

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================
// 1. ENUMS
// ============================================================

// Tipo de conta: autônomo ou estúdio
enum TenantType {
  AUTONOMO
  STUDIO
}

// Roles dentro de um tenant
enum UserRole {
  OWNER      // Dono do estúdio ou o próprio autônomo
  STAFF      // Funcionário geral (faz orçamentos, atendimento, agenda)
  EMPLOYEE   // Tatuador funcionário do estúdio
}

// Status do usuário
enum UserStatus {
  ACTIVE               // Ativo
  INACTIVE             // Inativo
}

// Tipo de autônomo
enum AutonomoType {
  OWN_SPACE  // Tem seu próprio espaço (paga aluguel)
  GUEST      // Faz guest em estúdios
}

// Categorias de lançamento financeiro
enum TransactionCategory {
  TATTOO      // Receita de tatuagem
  MATERIAL    // Compra de materiais
  FIXED       // Custos fixos (aluguel, energia, etc.)
  MARKETING   // Custos de marketing
  PRO_LABORE  // Pró-labore
  INVESTMENT  // Investimento
  OTHER       // Outros
}

// Tipo de lançamento
enum TransactionType {
  INCOME   // Entrada
  EXPENSE  // Saída
}

// Formas de pagamento
enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  CASH
}

// Tamanho da tatuagem (parâmetro de sugestão)
enum TattooSize {
  SMALL      // Pequena (até 7cm)
  MEDIUM     // Média (7cm a 10cm)
  LARGE      // Grande (10cm a 15cm)
  EXTRA_LARGE // Extra grande (15cm a 20cm)
  XLARGE      // XL (20cm a 40cm)
  FULL_BODY  // Full body / grande área(mais de 20 cm)
}

// Complexidade da tatuagem (parâmetro de sugestão)
enum TattooComplexity {
  LOW        // Baixa
  MEDIUM     // Média
  HIGH       // Alta
  VERY_HIGH  // Muito alta
}

// Local do corpo (parâmetro de sugestão)
enum BodyLocation {
  ARM          // Braço
  FOREARM      // Antebraço
  HAND         // Mão
  FINGER       // Dedo
  UPPER_BACK   // Costas superior
  LOWER_BACK   // Costas inferior
  FULL_BACK    // Costas inteiras
  CHEST        // Peito
  ABDOMEN      // Abdômen
  SHOULDER     // Ombro
  NECK         // Pescoço
  FACE         // Rosto
  HEAD         // Cabeça
  THIGH        // Coxa
  CALF         // Panturrilha
  FOOT         // Pé
  RIB          // Costela
  INNER_ARM    // Parte interna do braço
  WRIST        // Pulso
  ANKLE        // Tornozelo
  OTHER        // Outro
}

// ============================================================
// 2. TENANT (conta principal — autônomo ou estúdio)
// ============================================================

model Tenant {
  id        String     @id @default(cuid())
  type      TenantType
  name      String                          // Nome do estúdio ou do autônomo
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relações
  users          User[]
  clients        Client[]
  procedures     Procedure[]
  sessions       TattooSession[]
  transactions   Transaction[]
  fixedCosts     FixedCost[]
  variableCosts  VariableCost[]
  workSettings   WorkSettings?
  guestLocations GuestLocation[]            // Locais onde o autônomo faz guest
  linkedAsGuest  GuestLocation[] @relation("LinkedGuest") // Estúdios que são referenciados como guest
  studioConfig   StudioConfig?              // Configurações específicas do estúdio
}

// ============================================================
// 3. USUÁRIO E AUTENTICAÇÃO
// ============================================================

model User {
  id        String     @id @default(cuid())
  tenantId  String
  email     String     @unique
  name      String
  role      UserRole
  status    UserStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relações
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // Sessões de tatuagem realizadas por este tatuador
  tattooSessions  TattooSession[]
  // Procedimentos cadastrados por este tatuador
  procedures      Procedure[]
  // Benefícios recebidos dentro de um estúdio
  benefits        TatuadorBenefit[]
  // Modelo ML próprio do tatuador
  mlModels        MLModel[]
  // Dados de treinamento do modelo
  mlTrainingData  MLTrainingData[]
  // Predições feitas pelo modelo
  mlPredictions   MLPrediction[]
  
  // Better-Auth relations
  sessions Session[]
  accounts Account[]
}

// ============================================================
// BETTER-AUTH MODELS
// ============================================================

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String   // "email" | "oauth"
  provider          String   // "google" | "credentials"
  providerAccountId String?
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  // Para email/password
  password          String?
  emailVerified     DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

// ============================================================
// 4. CONFIGURAÇÕES DO ESTÚDIO
// ============================================================

// Configurações específicas quando o tenant é STUDIO
model StudioConfig {
  id                  String   @id @default(cuid())
  tenantId            String   @unique
  defaultPercentage  Int                    // Percentual padrão cobrado (ex: 30 = 30%)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  // Benefícios individuais por tatuador (sobrescreve o percentual padrão)
  tatuadorBenefits TatuadorBenefit[]
}

// Benefício individual de um tatuador dentro do estúdio
// Se existir, sobrescreve o percentual padrão do estúdio para esse tatuador
model TatuadorBenefit {
  id              String   @id @default(cuid())
  studioConfigId  String
  userId         String                   // Tatuador que recebe o benefício
  percentage      Int                      // Percentual específico para este tatuador
  reason          String?                  // Motivo do benefício (opcional)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  studioConfig StudioConfig @relation(fields: [studioConfigId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
}

// ============================================================
// 5. GUEST LOCATION (onde o autônomo faz guest)
// ============================================================

// Registra os estúdios onde o autônomo faz guest
// Pode ser um estúdio cadastrado na plataforma ou apenas um nome livre
model GuestLocation {
  id              String   @id @default(cuid())
  tenantId        String                   // Tenant do autônomo
  name            String                   // Nome do estúdio
  linkedTenantId  String?                  // Se o estúdio estiver cadastrado na plataforma
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  linkedTenant Tenant?         @relation("LinkedGuest", fields: [linkedTenantId], references: [id])
  // Sessões realizadas neste local
  sessions     TattooSession[]
}

// ============================================================
// 6. CLIENTE (da tatuagem)
// ============================================================

model Client {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  email     String?
  phone     String?
  notes     String?                        // Notas gerais sobre o cliente
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions TattooSession[] // Histórico de sessões do cliente
  transactions Transaction[] // Lançamentos financeiros associados
}

// ============================================================
// 7. PROCEDIMENTO (tipo de tatuagem cadastrado)
// ============================================================

// Cada procedimento cadastrado pelo tatuador serve como referência
// tanto para busca por semelhança quanto para treinamento do modelo ML
model Procedure {
  id           String          @id @default(cuid())
  tenantId     String
  userId      String                         // Tatuador que cadastrou
  name         String                         // Nome descritivo (ex: "Blackwork Braço")
  description  String?
  // Parâmetros para sugestão de valor
  size         TattooSize
  complexity   TattooComplexity
  bodyLocation BodyLocation
  // Valor cobrado (em centavos)
  finalPrice   Int
  // Duração da sessão em minutos
  duration     Int
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User            @relation(fields: [userId], references: [id])
  sessions TattooSession[] // Sessões que usaram este procedimento como referência
}

// ============================================================
// 8. SESSÃO DE TATUAGEM
// ============================================================

model TattooSession {
  id               String          @id @default(cuid())
  tenantId         String
  clientId         String
  userId          String                          // Tatuador que realizou
  procedureId      String?                         // Procedimento de referência (opcional)
  // Parâmetros da sessão
  size             TattooSize
  complexity       TattooComplexity
  bodyLocation     BodyLocation
  description      String?                         // Descrição livre da tatuagem
  // Valores (em centavos)
  finalPrice       Int                             // Valor cobrado ao cliente
  // Para autônomo guest
  guestLocationId  String?                         // Onde foi realizada (se for guest)
  studioPercentage Int?                            // Percentual cobrado pelo estúdio (em %)
  studioFee        Int?                            // Valor cobrado pelo estúdio (calculado, em centavos)
  tatuadorRevenue  Int?                            // O que o tatuador ficou (em centavos)
  // Duração em minutos
  duration         Int?
  // Data da sessão
  date             DateTime
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id])
  procedure     Procedure?    @relation(fields: [procedureId], references: [id])
  guestLocation GuestLocation? @relation(fields: [guestLocationId], references: [id])
  // Dados usados para treino do modelo ML
  mlTrainingData MLTrainingData?
  // Lançamento financeiro gerado por esta sessão
  transaction    Transaction?
}

// ============================================================
// 9. FINANCEIRO
// ============================================================

model Transaction {
  id          String              @id @default(cuid())
  tenantId    String
  type        TransactionType
  category    TransactionCategory
  amount      Int                                  // Valor em centavos
  paymentMethod PaymentMethod?
  clientId    String?                              // Cliente associado (se for tattoo)
  sessionId   String?  @unique                      // Sessão associada (se for tattoo)
  description String?
  date        DateTime
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client  Client?        @relation(fields: [clientId], references: [id])
  session TattooSession? @relation(fields: [sessionId], references: [id])
}

// ============================================================
// 10. CALCULADORA DE CUSTOS
// ============================================================

// Custos fixos mensais do tenant
model FixedCost {
  id        String   @id @default(cuid())
  tenantId  String
  name      String   // Ex: "Aluguel do Espaço"
  amount    Int      // Valor em centavos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// Custos variáveis mensais do tenant
model VariableCost {
  id        String   @id @default(cuid())
  tenantId  String
  name      String   // Ex: "Materiais (tintas, agulhas)"
  amount    Int      // Valor em centavos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// Configurações de trabalho (horas trabalhadas e margem de lucro)
model WorkSettings {
  id              String   @id @default(cuid())
  tenantId        String   @unique
  hoursPerMonth   Int      // Horas trabalhadas por mês
  profitMargin    Int      // Margem de lucro desejada em % (ex: 30 = 30%)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// 11. SISTEMA ML (Sugestão de valores por CatBoost)
// ============================================================

// Dados de treinamento extraídos de cada sessão concluída
// Alimenta o modelo CatBoost do tatuador
model MLTrainingData {
  id           String          @id @default(cuid())
  sessionId    String          @unique
  userId      String                          // Tatuador dono dos dados
  // Features (entrada do modelo)
  size         TattooSize
  complexity   TattooComplexity
  bodyLocation BodyLocation
  duration     Int                             // Duração em minutos
  // Target (saída do modelo — valor cobrado)
  finalPrice   Int                             // Valor em centavos
  createdAt    DateTime        @default(now())

  session TattooSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id])
}

// Registro de cada modelo treinado por tatuador
model MLModel {
  id            String   @id @default(cuid())
  userId       String                          // Tatuador dono do modelo
  trainedAt     DateTime                        // Quando foi treinado
  dataPointsUsed Int                            // Quantidade de sessões usadas no treino
  modelPath     String                          // Caminho do modelo salvo no disco/storage
  isActive      Boolean  @default(true)         // Se é o modelo atual ou um histórico
  createdAt     DateTime @default(now())

  user        User          @relation(fields: [userId], references: [id])
  predictions MLPrediction[]
}

// Histórico de predições feitas pelo modelo
model MLPrediction {
  id           String          @id @default(cuid())
  userId      String                          // Tatuador
  modelId      String                          // Modelo usado
  // Features usadas na predição
  size         TattooSize
  complexity   TattooComplexity
  bodyLocation BodyLocation
  // Resultado
  predictedPrice Int                           // Valor sugerido em centavos
  // Se o usuário aceitou ou ajustou
  acceptedPrice  Int?                          // Valor final usado (null se não foi usado)
  createdAt      DateTime        @default(now())

  user  User    @relation(fields: [userId], references: [id])
  model MLModel @relation(fields: [modelId], references: [id])
}
